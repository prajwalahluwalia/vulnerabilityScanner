import json
import logging
from datetime import datetime
import csv

class VulnerabilityScanner:
    def __init__(self, key,  results):
        self.key = key
        self.results = results
        
    def scan_vulerabilities(self):
        vulnerabilities = {}
        final = []
        results = json.loads(json.dumps(self.results))
        for result in results:
            res = eval(result)
            if res[-1]!='No Banner found.':
                if self.check_vulerabilities(res):
                    final.append(res)
        
        vulnerabilities[self.key]=final
                    
        return vulnerabilities
                
    def check_vulerabilities(self, res):
        banners = res[1]
        with open('./allitems.csv') as csvfile:
            reader = csv.reader(csvfile)
            for banner in banners:
                
                for row in reader:
                    if row.strip() in banner:
                        logging.info(f'[+{datetime.now()} vulnerability_scanner]: Open port: {str(res[0])}-{self.key}')
                        return True
            
            return False