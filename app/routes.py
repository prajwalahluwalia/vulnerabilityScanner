from flask import Flask, request, redirect, render_template, url_for
from app import app
from app.ehFunc.port_sanner import PortScanner
from app.ehFunc.vulnerability_scanner import VulnerabilityScanner
import json

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/login_form')
def login_form():
    return render_template('auth/login.html')

@app.route('/register_form')
def register_form():
    return render_template('auth/register.html')

@app.route('/check_ports', methods=["POST"])
def get_port_details():
    start = 1
    end = 65535

    targets = request.form['targets']
    
    if request.form['start']:
        start = int(request.form['start'])
        
    if request.form['end']:
        end = int(request.form['end'])
    
    print("Started")
    port_scanner = PortScanner(targets, start, end)
    print("Proceeding...")
    res = port_scanner.get_port_details()
    print(res)
    return redirect(url_for('open_ports', results = json.dumps(res), start = start, end = end))
    
@app.route('/open_ports', methods=["GET"])
def open_ports():
    results = json.loads(request.args.get('results'))
    # targets = request.args.get('targets')
    start = request.args.get('start')
    end = request.args.get('end')
    
    return render_template('scan_details.html',results = results, start=start, end=end, type="ports", scan_type = 'Port scan')

@app.route('/vulnerability_scanner', methods = ["GET"])
def vulnerability_scanner():
    key = request.args.get('key')
    results = request.args.getlist('results')
    
    scanner = VulnerabilityScanner(key, results)
    results = scanner.scan_vulerabilities()
    
    return render_template('scan_details.html',results = results, start='1' , end='65535', type="vulnerability", scan_type = 'Vulnerability scan')